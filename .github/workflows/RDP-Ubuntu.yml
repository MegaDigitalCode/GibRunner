name: RDP-Ubuntu-Public

on:
  workflow_dispatch:
    inputs:
      dynamic_chat_id:
        required: true
      dynamic_token:
        required: true
      runner_secret:
        required: true
      worker_url:
        required: true
      language:
        required: true
        default: 'en'

jobs:
  rdp-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      PYTHONIOENCODING: utf-8
    steps:
      - name: Masking Secrets
        env:
          MASK_TOKEN: ${{ github.event.inputs.dynamic_token }}
          MASK_RUNNER_SECRET: ${{ github.event.inputs.runner_secret }}
        run: |
          printf '%s\n' "::add-mask::$MASK_TOKEN"
          printf '%s\n' "::add-mask::$MASK_RUNNER_SECRET"

      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python libs
        run: pip install pyTelegramBotAPI psutil requests

      - name: Install desktop deps and tmate
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies xvfb dbus-x11 curl wget tmate

      - name: Install RustDesk
        run: |
          URL=$(curl -fsSL https://api.github.com/repos/rustdesk/rustdesk/releases/latest \
            | grep browser_download_url \
            | grep 'x86_64.deb' \
            | head -n1 \
            | cut -d '"' -f 4)

          if [ -z "$URL" ]; then
            echo "Failed to locate latest RustDesk .deb"
            exit 1
          fi

          wget -qO rustdesk.deb "$URL"
          sudo apt-get install -y ./rustdesk.deb

      - name: Start virtual desktop session
        run: |
          export DISPLAY=:1
          nohup Xvfb :1 -screen 0 1366x768x24 >/tmp/xvfb.log 2>&1 &
          sleep 2
          nohup startxfce4 >/tmp/xfce.log 2>&1 &
          sleep 3

      - name: Run Controller
        env:
          TG_TOKEN: ${{ github.event.inputs.dynamic_token }}
          TG_CHATID: ${{ github.event.inputs.dynamic_chat_id }}
          WORKER_URL: ${{ github.event.inputs.worker_url }}
          USER_LANG: ${{ github.event.inputs.language }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          SESSION_SECRET: ${{ github.event.inputs.runner_secret }}
          DISPLAY: ':1'
        run: python bot_master.py
